import os
from dotenv import load_dotenv
load_dotenv()

# ================================================================
#  Telegram 接続設定（.env ファイルで管理）
#  変更方法: .env を編集する。ここは触らない。
# ================================================================
TELEGRAM_TOKEN   = os.getenv("TELEGRAM_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

# ================================================================
#  スキャン対象チェーン
#  現在 Solana のみ対応。変更不要。
# ================================================================
CHAIN = "solana"

# ================================================================
#  スキャン対象の時価総額（MC）レンジ　※起動後は /setmc で変更可
#
#  MC_MIN: この金額未満のコインは無視する（小さすぎるコインを除外）
#  MC_MAX: この金額超のコインは無視する（大きすぎるコインを除外）
#
#  例: MC_MIN = 500_000  → $500K 未満は除外
#      MC_MAX = 50_000_000 → $50M 超は除外
#
#  カンマ区切りで書くと読みやすい（1_000_000 = $1M）
# ================================================================
MC_MIN = 500_000       # $500K
MC_MAX = 50_000_000    # $50M

# ================================================================
#  最低流動性フィルター
#
#  LIQ_MIN: 流動性がこの金額未満のプールはスキャン対象外にする
#  流動性が低いと価格操作されやすいため除外する。
#
#  例: 10_000 → $10K 未満のプールをスキップ
# ================================================================
LIQ_MIN = 10_000       # $10K

# ================================================================
#  自動スキャンの間隔　※起動後は /setinterval で変更可
#
#  単位: 秒
#  例: 300 = 5分ごと / 60 = 1分ごと / 600 = 10分ごと
#
#  短くするほどリアルタイム性は上がるが API に負荷がかかる。
#  無料プランの GeckoTerminal は 30req/分 が上限なので
#  スキャン対象が多い場合は 300秒（5分）以上を推奨。
# ================================================================
SCAN_INTERVAL = 300    # 秒（デフォルト: 5分）

# ================================================================
#  通知閾値　※起動後は /threshold で変更可
#
#  スコアがこの点数以上のコインだけ Telegram に通知する。
#  100点満点。高くするほど通知は減り、精度が上がる（はず）。
#
#  目安:
#    80点以上 → 厳選。通知は少ないが精度重視
#    70点以上 → バランス型（デフォルト）
#    60点以上 → 緩め。通知が増えるがノイズも増える
# ================================================================
NOTIFY_THRESHOLD = 70

# ================================================================
#  RSI の計算期間
#
#  一般的な 14 ではなくミームコイン向けに 9 を使用。
#  短い期間ほど価格変動に敏感に反応する。
#  変更する場合は MIN_CANDLES（後述）も自動で更新される。
# ================================================================
RSI_PERIOD = 9

# ================================================================
#  ATR の計算期間
#
#  ボラティリティの計算に使う。14 が標準的。
#  短くすると最近の値動きだけを見る。長くすると平均的な振れ幅を見る。
# ================================================================
ATR_PERIOD = 14

# ================================================================
#  MC帯別パラメータ
#
#  コインの時価総額（MC）によってスキャン基準を変える。
#  小さいコインほど動きが激しいため、閾値を高めに設定している。
#
#  【帯の構成】
#    帯1: $300K〜$1M  （超マイクロキャップ）
#    帯2: $1M〜$5M   （スモールキャップ）
#    帯3: $5M〜$50M  （ミッドキャップ）
#
#  【各パラメータの説明】
#
#  mc_min / mc_max
#    この帯が適用される MC の範囲（$）。
#    帯を追加・削除する場合はここを変える。
#
#  rsi_overbought（RSI 過熱閾値）
#    RSI がこの値を超えると「買われすぎ」と判断し、
#    スコアにペナルティ（最大 −15点）が入る。
#    値を上げる → より強い過熱でないとペナルティにならない（ペナルティが入りにくい）
#    値を下げる → 少し上昇しただけでペナルティになる（厳しめ）
#
#  atr_sl_mult（損切り幅の倍率）
#    損切り価格 = エントリー価格 − ATR × atr_sl_mult
#    値を大きくする → 損切り幅が広がる（引っかかりにくくなる）
#    値を小さくする → 損切り幅が狭まる（すぐ損切りになる）
#
#  atr_tp_mult（利確幅の倍率）
#    利確価格 = エントリー価格 + ATR × atr_tp_mult
#    値を大きくする → 利確目標が遠くなる（大きく取れるが届きにくい）
#    値を小さくする → 利確目標が近くなる（届きやすいが利幅が小さい）
#
#  volume_surge_min（出来高急増の判定倍率）
#    直近1本の出来高が直前20本平均の何倍以上なら「急増」と判定するか。
#    値を上げる → より大きな急増でないとスコアが入らない（厳しめ）
#    値を下げる → 少しの出来高増でもスコアが入る（緩め）
#
#  ohlcv_aggregate（使用するローソク足の時間軸・分）
#    指標計算に使うローソク足の長さ。
#    短い足（5分）→ 細かい動きを捉えやすい / ノイズも多い
#    長い足（15分）→ 大きなトレンドを捉える / 反応は遅め
# ================================================================
MC_BAND_PARAMS = [
    # ────────────────────────────────────────
    #  帯1: $300K〜$1M（超マイクロキャップ）
    #  非常に値動きが荒い。急騰・急落が多い。
    # ────────────────────────────────────────
    {
        "mc_min":          300_000,   # 下限 $300K
        "mc_max":        1_000_000,   # 上限 $1M
        "rsi_overbought":       91,   # RSI 91 超で過熱ペナルティ
        "atr_sl_mult":         2.5,   # 損切り = ATR × 2.5
        "atr_tp_mult":         6.5,   # 利確   = ATR × 6.5
        "volume_surge_min":    5.0,   # 出来高が平均の5倍以上で急増判定
        "ohlcv_aggregate":       5,   # 5分足を使用
    },
    # ────────────────────────────────────────
    #  帯2: $1M〜$5M（スモールキャップ）
    #  値動きは大きめだが帯1よりは安定。
    # ────────────────────────────────────────
    {
        "mc_min":        1_000_000,   # 下限 $1M
        "mc_max":        5_000_000,   # 上限 $5M
        "rsi_overbought":       87,   # RSI 87 超で過熱ペナルティ
        "atr_sl_mult":         2.0,   # 損切り = ATR × 2.0
        "atr_tp_mult":         5.0,   # 利確   = ATR × 5.0
        "volume_surge_min":    3.0,   # 出来高が平均の3倍以上で急増判定
        "ohlcv_aggregate":      15,   # 15分足を使用（GeckoTerminalは1/5/15のみ対応）
    },
    # ────────────────────────────────────────
    #  帯3: $5M〜$50M（ミッドキャップ）
    #  3帯の中では最も安定。大きな資金が動きやすい。
    # ────────────────────────────────────────
    {
        "mc_min":        5_000_000,   # 下限 $5M
        "mc_max":       50_000_000,   # 上限 $50M
        "rsi_overbought":       82,   # RSI 82 超で過熱ペナルティ
        "atr_sl_mult":         1.75,  # 損切り = ATR × 1.75
        "atr_tp_mult":         4.0,   # 利確   = ATR × 4.0
        "volume_surge_min":    2.0,   # 出来高が平均の2倍以上で急増判定
        "ohlcv_aggregate":      15,   # 15分足を使用
    },
]

def get_mc_params(mc: float) -> dict:
    """
    MCの値から該当するMC帯パラメータを返す。
    どの帯にも該当しない場合はミッドキャップのパラメータで代用。
    """
    for band in MC_BAND_PARAMS:
        if band["mc_min"] <= mc < band["mc_max"]:
            return band
    return MC_BAND_PARAMS[-1]

# ================================================================
#  GeckoTerminal OHLCV 取得設定
#
#  OHLCV_TIMEFRAME: 取得する時間軸の種類。"minute" 固定。
#                   aggregate（MC帯別）で実際の足の長さを調整する。
#  OHLCV_LIMIT    : 1回の取得で何本分のローソク足を取得するか。
#                   増やすと再現性の計算精度が上がるが取得時間が増える。
#                   最大 1000。RSI+ATR の計算に最低 15 本必要。
# ================================================================
OHLCV_TIMEFRAME = "minute"
OHLCV_LIMIT     = 100

# ================================================================
#  API 設定（基本的に変更不要）
#
#  DEX_REQUEST_INTERVAL : DexScreener へのリクエスト間隔（秒）
#  GT_REQUEST_INTERVAL  : GeckoTerminal へのリクエスト間隔（秒）
#                         無料プランは 30req/分 → 2秒間隔が安全
# ================================================================
DEX_BASE_URL = "https://api.dexscreener.com"
DEX_REQUEST_INTERVAL = 1.0   # 秒

GT_BASE_URL = "https://api.geckoterminal.com/api/v2"
GT_HEADERS  = {"Accept": "application/json;version=20230302"}
GT_REQUEST_INTERVAL = 2.0    # 秒（無料プラン上限: 30req/分）

# ================================================================
#  トレンドプールの集計期間
#
#  GeckoTerminal trending_pools の duration パラメータ。
#  直近この期間の取引量・サイト訪問数でトレンドを算出する。
#
#  選択肢: "5m" / "1h" / "6h" / "24h"（デフォルト）
#  スキャルピング用途では短い期間ほど直近の勢いを捉えやすい。
#    "5m"  → 直近5分（ノイズが多い）
#    "1h"  → 直近1時間（比較的新鮮）
#    "6h"  → 直近6時間（バランス型）★現在の設定
#    "24h" → 直近24時間（動き終わったコインを拾いやすい）
# ================================================================
GT_TRENDING_DURATION = "6h"

# ================================================================
#  重複通知の抑制時間
#
#  同じトークンを通知してからこの秒数が経過するまで再通知しない。
#  例: 3600 = 1時間は同じコインを通知しない
#  短くする → 同じコインを頻繁に通知する
#  長くする → 一度通知したコインはしばらく無視する
# ================================================================
NOTIFY_TTL = 3600   # 秒（デフォルト: 1時間）

# ================================================================
#  指標計算に必要な最低ローソク足本数（変更不要）
#
#  RSI と ATR はそれぞれ独立して計算されるため、
#  必要本数は合計ではなく各指標の必要本数の最大値になる。
#  RSI(9)  : RSI_PERIOD + 1 = 10 本以上必要
#  ATR(14) : ATR_PERIOD + 1 = 15 本以上必要
#  → max(10, 15) = 15 本。これを下回るコインはスキップする。
# ================================================================
MIN_CANDLES = max(RSI_PERIOD + 1, ATR_PERIOD + 1)   # = 15
